[{"id":1604,"date":"2018-07-15T12:30:06","date_gmt":"2018-07-15T12:30:06","guid":{"rendered":"https://api.scott.ee/?p=1604"},"modified":"2018-11-15T20:21:04","modified_gmt":"2018-11-15T20:21:04","slug":"the-perfect-pi","status":"publish","type":"post","link":"https://api.scott.ee/journal/the-perfect-pi/","title":{"rendered":"The Perfect Pi"},"content":{"rendered":"\n<p>In my next few posts I will be writing about my home automation setup which is based around a handful of Raspberry Pis. First though I want to document how I setup and get the most out of these fantastic little machines.</p>\n<p><noscript><img class=\"alignnone wp-image-1635\" src=\"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=900%2C502&amp;ssl=1\" alt=\"A Raspberry Pi Zero computer on a grey background\" width=\"900\" height=\"502\" srcset=\"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?w=1500&amp;ssl=1 1500w, https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=250%2C140&amp;ssl=1 250w, https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=768%2C429&amp;ssl=1 768w, https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=700%2C391&amp;ssl=1 700w, https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=120%2C67&amp;ssl=1 120w\" sizes=\"(max-width: 900px) 100vw, 900px\" data-recalc-dims=\"1\"></noscript><div class=\"lazy\" data-width=\"900\" data-height=\"502\" style=\"--ratio:55.78%;\"><img class=\"alignnone wp-image-1635\" src=\"\" alt=\"A Raspberry Pi Zero computer on a grey background\" width=\"900\" height=\"502\" srcset=\"\" sizes=\"(max-width: 900px) 100vw, 900px\" data-recalc-dims=\"1\" data-src=\"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=900%2C502&amp;ssl=1\" data-srcset=\"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?w=1500&amp;ssl=1 1500w, https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=250%2C140&amp;ssl=1 250w, https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=768%2C429&amp;ssl=1 768w, https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=700%2C391&amp;ssl=1 700w, https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=120%2C67&amp;ssl=1 120w\"></div></p>\n<h3>Grab Raspbian Lite</h3>\n<p>Head over to <a href=\"https://www.raspberrypi.org/downloads/raspbian/\">raspberrypi.org</a> and download the latest copy of Raspbian Lite. Every single Pi I have ever setup has been a headless machine so you don&rsquo;t need the bloat of the desktop environment. <a href=\"https://etcher.io/\">Etcher</a> is a great tool for flashing the downloaded image to your SD card. Whilst you have the SD card in your computer, create a <a href=\"https://www.raspberrypi.org/documentation/remote-access/ssh/\">blank file</a> called <code>ssh</code> in the <code>boot</code> directory to enable <code>ssh</code> and consider adding <a href=\"https://www.raspberrypi.org/documentation/configuration/wireless/headless.md\">wireless network information</a> if your Pi will be using WiFi.</p>\n<h3>Set a Fixed IP</h3>\n<p>A fixed IP will make it easier to reliably <code>ssh</code> into the machine and browse to any services it may be running. I always set a static IP via my router. I find this a little quicker and simpler to do than on the Raspberry Pi itself and it makes the Pi more portable should I ever change my network, or take it elsewhere. Your router documentation should be able to guide you through the process.</p>\n<h3>Login and Update</h3>\n<pre>ssh pi@192.168.1.10</pre>\n<p>Once you have set your static IP you can login via terminal with the <code>pi</code> username and the default password of <code>raspberry</code>. You can then update the default software stack using:</p>\n<pre>sudo apt-get update\r\nsudo apt-get upgrade</pre>\n<h3>Raspi Config</h3>\n<p>This little utility will do a number of things. It will expand the file system, giving you access to the entire SD card, set a memorable hostname and lower the GPU memory to minimum (16mb). With the Pi running headless you shouldn&rsquo;t really need any graphics memory and this gives you the maximum amount of RAM for your projects and code. Run the utility with <code>raspi-config</code>, key around to change the above settings. Once that is done you will need to reboot and login again.</p>\n<p>After rebooting it is worth checking your time and timezone with <code>dpkg-reconfigure tzdata</code>. It has a similar interface to <code>raspi-config</code> and should be easy to find your way around with the keyboard.</p>\n<h3>Add a New User</h3>\n<p>It is a good idea to create your own user account and trash the original pi user. This will keep your Pi nice and safe should you expose it to the Internet or invite a hacker to stay in your house. Run the following commands in sequence replacing <code>&lt;name&gt;</code> with your chosen username.</p>\n<pre>sudo useradd -m &lt;name&gt; -G sudo\r\nsudo passwd &lt;name&gt;\r\nexit\r\nssh &lt;name&gt;@192.168.1.10\r\nsudo adduser &lt;name&gt; video\r\nsudo deluser -remove-home pi</pre>\n<p>These steps will:</p>\n<ul><li>Create you new user and add it to the <code>sudo</code> group</li>\n<li>Setup your password for your new user</li>\n<li>Logout</li>\n<li>Log back in again (remember to change the IP to that of your Pi)</li>\n<li>Add your new user to the video group which fixes a few Raspberry Pi tools like checking CPU temp</li>\n<li>Delete the original pi user and all files in the home directory (make sure you have backed up what you need there first)</li>\n</ul><p>If you find you are unable to autocomplete (tab) commands in your terminal with your new user it may be because you are using the wrong shell. You can fix this <a href=\"https://serverfault.com/a/99791\">following the guide here</a>.</p>\n<h3>Install Git</h3>\n<pre>sudo apt-get install git-core</pre>\n<p>I try to store most of my project code on <a href=\"https://github.com/scottsweb\">GitHub</a> if possible and the git-core package will make it possible to push and pull code from the command line. Whilst you are messing around with Git I recommend taking a look at the <a href=\"https://github.com/azlux/log2ram%EF%BF%BD\">log2ram project</a>. It will store all of your system logs in RAM which is useful for reducing SD card wear and prolonging the life of the card. I don&rsquo;t use it on all my Pi projects but it can be useful on busy systems where you have some RAM to spare.</p>\n<h3>Speed Tweaks</h3>\n<p>As well as the usual <a href=\"https://www.raspberrypi.org/documentation/configuration/config-txt/overclocking.md\">processor overclocking</a> that you <em>can</em> do (I haven&rsquo;t felt the need yet), you can also improve the performance of the SD card. To do so edit <code>boot/config.txt</code> and add <code>dtoverlay=sdhost,overclock_50=100</code> on a new line in the file. The overclock value will need to be adjusted to suit the SD card you are using. It is a fairly <a href=\"https://www.jeffgeerling.com/blog/2016/how-overclock-microsd-card-reader-on-raspberry-pi-3\">involved process</a> to get the best value for your card but can make a real difference. <code>dmesg</code> is also useful for spotting issues. You should note that this change can cause issues with WiFi too if you are relying on that for your network connection.</p>\n<h3>Power Tweaks</h3>\n<p>One of my favourite things about Raspberry Pis is how power efficient they are. It means you can leave them all the time without worrying about the environmental impact or huge energy bills. With a few additional tweaks you can save a few more milliamps. There are some great tips come from&nbsp;Jeff Geerling in these <a href=\"http://www.jeffgeerling.com/blogs/jeff-geerling/raspberry-pi-zero-conserve-energy%EF%BF%BD\">excellent</a> <a href=\"http://www.jeffgeerling.com/blogs/jeff-geerling/controlling-pwr-act-leds-raspberry-pi%EF%BF%BD\">posts</a> that are worth running through. My favourite tweak is disabling the HDMI circuitry by adding <code>/usr/bin/tvservice -o</code> to <code>/etc/rc.local</code>.</p>\n<h3>Docker</h3>\n<p><a href=\"https://www.docker.com/\">Docker</a> is a containerisation software that allows you to isolate software applications. Containers are more lightweight than traditional virtual machines. I find Docker the best way to run services on the Raspberry Pi, it allows me to get the most out of the resources available and removes the need to for reformat the SD card every time my tinkering goes a bit too far. Install docker with the following command and then add your user to the docker group:</p>\n<pre>curl -sSL https://get.docker.com | sh\r\nsudo usermod -aG docker &lt;name&gt;\r\n</pre>\n<p>Once again replace <code>&lt;name&gt;</code> with your chosen username. I recommend installing docker compose too. This will allow you to configure and start you containers reliably from <code class=\"highlighter-rouge\">docker-compose.yml</code> config files.</p>\n<pre>sudo apt-get install python-pip\r\nsudo pip install docker-compose\r\n</pre>\n<p>This last Docker trick is optional. Docker can use quite a bit of space on your SD card so if you have external storage (like a hard drive) it can sometimes be beneficial to move <a href=\"http://stackoverflow.com/questions/24309526/how-to-change-the-docker-image-installation-directory\">dockers internals to a different storage location</a>. Edit the docker.service file (<code>sudo nano /lib/systemd/system/docker.service</code>) and modify the line starting with <code>ExecStart</code> to be:</p>\n<pre>ExecStart=/usr/bin/dockerd -H fd:// -g /path/to/external/storage/\r\n</pre>\n<p>The path should be to your external storage. You can then restart Docker and check the change has saved by running:</p>\n<pre>sudo systemctl daemon-reload\r\nsudo systemctl restart docker\r\ndocker info | grep \"loop file\\|Dir\"\r\n</pre>\n<p>Updating Docker in future may require you to make this change again. You will know if it needs doing as your containers and images will disappear after an update.</p>\n<h3>SSH</h3>\n<p>Almost done. These next few steps will configure SSH, allow for a simpler login (SSH via public key) and mount an external server using <code>sshfs</code>. First generate some keys with <code>ssh-keygen -b 2048 -t rsa</code> and add public keys from your other computers to: <code>.ssh/authorized_keys</code>. <code>sshfs</code> should be installed with <code>sudo apt-get install sshfs</code>. Once installed you can mount your external server by editing <code>/etc/fstab</code> and adding:</p>\n<pre>&lt;name&gt;@192.168.1.11:/media/data/ /media/path/ fuse.sshfs _netdev,nonempty,allow_other,IdentityFile=/home/&lt;name&gt;/.ssh/id_rsa,reconnect,ServerAliveInterval=45,ServerAliveCountMax=2 0 0\r\n</pre>\n<p>Make sure you set the relevant paths, IP addresses and usernames in the fstab entry above. Test it <a href=\"https://serverfault.com/questions/174181/how-do-you-validate-fstab-without-rebooting\">without a reboot</a> by typing <code>sudo mount -a</code>.</p>\n<p>With all that completed you are now set with the perfect slice of Pi. Time to get hacking on your projects!</p>\n<h3>Optional Extras</h3>\n<ul><li>Tweak <a href=\"https://www.bitpi.co/2015/02/11/how-to-change-raspberry-pis-swapfile-size-on-rasbian/%EF%BF%BD\">your swap</a> if RAM is tight (works well with <a href=\"https://www.raspberrypi.org/products/compute-module-3/\">compute modules</a>)</li>\n<li><a href=\"http://blog.dustinkirkland.com/2011/02/long-overdue-introduction-ecryptfs.html\">Encrypt your home folder</a></li>\n<li><a href=\"http://longsteve.com/wiki/index.php?title=USB_Hard_Drive_Encryption_on_a_Raspberry_Pi\">Encrypt an external drive</a></li>\n<li><a href=\"https://wiki.ubuntu.com/MountWindowsSharesPermanently\">Mount a samba/Windows share</a></li>\n<li>Adjust the <a href=\"http://www.embeddedpi.com/documentation/installing-linux-os/cm3-speed-thermal-os-configuration-options%EF%BF%BD\">thermal properties of the CPU</a></li>\n</ul>\n","protected":false},"excerpt":{"rendered":"In my next few posts I will be writing about my home automation setup which is based around a handful of Raspberry Pis. First though I want to document how I setup and get the most out of these fantastic little machines. Grab Raspbian Lite Head over to raspberrypi.org and download the latest copy of</p><p><a class=\"view-article\" href=\"https://api.scott.ee/journal/the-perfect-pi/\">Read more</a></p>","protected":false},"author":1,"featured_media":1635,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[22,20],"tags":[],"jetpack_featured_media_url":"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?fit=1500%2C837&ssl=1","_links":{"self":[{"href":"https://api.scott.ee/wp-json/wp/v2/posts/1604"}],"collection":[{"href":"https://api.scott.ee/wp-json/wp/v2/posts"}],"about":[{"href":"https://api.scott.ee/wp-json/wp/v2/types/post"}],"author":[{"embeddable":true,"href":"https://api.scott.ee/wp-json/wp/v2/users/1"}],"replies":[{"embeddable":true,"href":"https://api.scott.ee/wp-json/wp/v2/comments?post=1604"}],"version-history":[{"count":26,"href":"https://api.scott.ee/wp-json/wp/v2/posts/1604/revisions"}],"predecessor-version":[{"id":1650,"href":"https://api.scott.ee/wp-json/wp/v2/posts/1604/revisions/1650"}],"wp:featuredmedia":[{"embeddable":true,"href":"https://api.scott.ee/wp-json/wp/v2/media/1635"}],"wp:attachment":[{"href":"https://api.scott.ee/wp-json/wp/v2/media?parent=1604"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https://api.scott.ee/wp-json/wp/v2/categories?post=1604"},{"taxonomy":"post_tag","embeddable":true,"href":"https://api.scott.ee/wp-json/wp/v2/tags?post=1604"}],"curies":[{"name":"wp","href":"https://api.w.org/{rel}","templated":true}]},"_embedded":{"author":[{"id":1,"name":"scottsweb","url":"","description":"","link":"https://api.scott.ee/journal/author/scottsweb/","slug":"scottsweb","_links":{"self":[{"href":"https://api.scott.ee/wp-json/wp/v2/users/1"}],"collection":[{"href":"https://api.scott.ee/wp-json/wp/v2/users"}]}}],"wp:featuredmedia":[{"id":1635,"date":"2018-07-15T12:17:39","slug":"journal-pi-zero","type":"attachment","link":"https://api.scott.ee/journal/the-perfect-pi/journal-pi-zero/","title":{"rendered":"Raspberry Pi"},"author":1,"caption":{"rendered":""},"alt_text":"A Raspberry Pi Zero computer on a grey background","media_type":"image","mime_type":"image/jpeg","media_details":{"width":1500,"height":837,"file":"journal-pi-zero.jpg","sizes":{"thumbnail":{"file":"journal-pi-zero-150x150.jpg","width":150,"height":150,"mime_type":"image/jpeg","source_url":"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=150%2C150&ssl=1"},"medium":{"file":"journal-pi-zero-250x140.jpg","width":250,"height":140,"mime_type":"image/jpeg","source_url":"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=250%2C140&ssl=1"},"medium_large":{"file":"journal-pi-zero-768x429.jpg","width":768,"height":429,"mime_type":"image/jpeg","source_url":"https://api.scott.ee/wp-content/uploads/journal-pi-zero-768x429.jpg"},"large":{"file":"journal-pi-zero-700x391.jpg","width":700,"height":391,"mime_type":"image/jpeg","source_url":"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=700%2C391&ssl=1"},"small":{"file":"journal-pi-zero-120x67.jpg","width":120,"height":67,"mime_type":"image/jpeg","source_url":"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=120%2C67&ssl=1"},"avatar":{"file":"journal-pi-zero-64x64.jpg","width":64,"height":64,"mime_type":"image/jpeg","source_url":"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?resize=64%2C64&ssl=1"},"full":{"file":"journal-pi-zero.jpg?fit=1500%2C837&ssl=1","width":1500,"height":837,"mime_type":"image/jpeg","source_url":"https://i0.wp.com/api.scott.ee/wp-content/uploads/journal-pi-zero.jpg?fit=1500%2C837&ssl=1"}},"image_meta":{"aperture":"0","credit":"","camera":"","caption":"","created_timestamp":"0","copyright":"","focal_length":"0","iso":"0","shutter_speed":"0","title":"","orientation":"0","keywords":[]}},"source_url":"https://api.scott.ee/wp-content/uploads/journal-pi-zero.jpg","_links":{"self":[{"attributes":[],"href":"https://api.scott.ee/wp-json/wp/v2/media/1635"}],"collection":[{"attributes":[],"href":"https://api.scott.ee/wp-json/wp/v2/media"}],"about":[{"attributes":[],"href":"https://api.scott.ee/wp-json/wp/v2/types/attachment"}],"author":[{"attributes":{"embeddable":true},"href":"https://api.scott.ee/wp-json/wp/v2/users/1"}],"replies":[{"attributes":{"embeddable":true},"href":"https://api.scott.ee/wp-json/wp/v2/comments?post=1635"}]}}],"wp:term":[[{"id":22,"link":"https://api.scott.ee/journal/category/open-source/","name":"Open Source","slug":"open-source","taxonomy":"category","_links":{"self":[{"href":"https://api.scott.ee/wp-json/wp/v2/categories/22"}],"collection":[{"href":"https://api.scott.ee/wp-json/wp/v2/categories"}],"about":[{"href":"https://api.scott.ee/wp-json/wp/v2/taxonomies/category"}],"wp:post_type":[{"href":"https://api.scott.ee/wp-json/wp/v2/posts?categories=22"}],"curies":[{"name":"wp","href":"https://api.w.org/{rel}","templated":true}]}},{"id":20,"link":"https://api.scott.ee/journal/category/projects/","name":"Project","slug":"projects","taxonomy":"category","_links":{"self":[{"href":"https://api.scott.ee/wp-json/wp/v2/categories/20"}],"collection":[{"href":"https://api.scott.ee/wp-json/wp/v2/categories"}],"about":[{"href":"https://api.scott.ee/wp-json/wp/v2/taxonomies/category"}],"wp:post_type":[{"href":"https://api.scott.ee/wp-json/wp/v2/posts?categories=20"}],"curies":[{"name":"wp","href":"https://api.w.org/{rel}","templated":true}]}}],[]]},"page":1}]